<!DOCTYPE html>
<html>
<head>
    <title></title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css" integrity="sha256-2YQRJMXD7pIAPHiXr0s+vlRWA7GYJEK0ARns7k2sbHY=" crossorigin="anonymous" />

    <link rel="stylesheet" href="css/index.css">
</head>
<body>
    <div class="container">
        <div class="row">
            <div class="one-half column">
                <h2>/r/ Image Downloader</h2>
                <p>This webpage downloads images from <a href="https://www.reddit.com/reddits">subreddits</a>, zips them up and hands them to you, all through your browser.</p>
                <p>Because of technical limitations, it is <b>normal for your tab to freeze</b> when downloading. The downloading experience is best while using Google Chrome.</p>
                <p>The lookup and downloading code is on the client-side, which means that this website does <b>not</b> know anything about what you're downloading.</p>
            </div>
            <div class="one-half column">
                <h2>&nbsp;</h2>

                <div class="row">
                    <div class="one-half column">
                        <label for="subNameInput">Subreddit</label>
                        <input class="u-full-width" id="subNameInput" type="text" placeholder="AdviceAnimals">
                    </div>
                    <div class="one-half column">
                        <label for="maxImageCountInput">Max Image Count</label>
                        <input class="u-full-width" id="maxImageCountInput" type="number" step="5" min="5" value="20">
                    </div>
                </div>

                <input class="u-full-width" id="cancelButton" type="button">
                <input class="button-primary u-full-width" id="downloadButton" value="Download" type="submit">
            </div>
        </div>
    </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.min.js" integrity="sha256-FPJJt8nA+xL4RU6/gsriA8p8xAeLGatoyTjldvQKGdE=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js" integrity="sha256-RbP/rbx4XeYJH6eYUniR63Jk5NEV48Gjestg49cNSWY=" crossorigin="anonymous"></script>

<script type="text/javascript">
    var CORS_PROXY_URL = "https://cors-anywhere.herokuapp.com/";

    var downloadInterval;
    var downloadRequests;
    var downloadedCount;
    var toDownloadCount;
    var subName;

    var zip = new JSZip();

    $("#downloadButton").click(function() {
        downloadRequests = new Set();
        downloadedCount = 0;
        toDownloadCount = 0;
        subName = $("#subNameInput").val();

        updateCancelButton();

        $(this).hide();
        $("#cancelButton").show();

        $.ajax({
            url: CORS_PROXY_URL + "https://www.reddit.com/r/" + subName + "/hot.json",
            type: "GET",
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function(result) {
                var children = result.data.children;

                if (children.length > 0) {
                    for (var i = 0; i < Math.min(children.length, $("#maxImageCountInput").val()); i++) {
                        var post = children[i].data;

                        if (post.preview !== undefined && post.preview.images.length > 0) {
                            var url = post.preview.images[0].source.url;

                            if (url.indexOf(".jpg?") !== -1) {
                                if (url.startsWith("http:")) {
                                    url = url.replace("http:", "https:");
                                }

                                toDownloadCount++;

                                downloadImageAsBase64(url, function(url, data) {
                                    zip.file(url.replace(/(.+\/)/, "").replace(/(\?.+)/, ""), data, { base64: true });
                                    downloadedCount++;
                                    updateCancelButton();
                                });
                            }
                        }
                    }

                    downloadInterval = setInterval(function() {
                        if (downloadedCount == toDownloadCount) {
                            doneDownloading();
                        }
                    }, 250);
                }
            },
            error: function(error) {
                if (error.status != 200) {
                    $("#subNameInput").addClass("incorrect-input");
                }
                doneDownloading();
            }
        });
    });

    $("#subNameInput").keypress(function() {
        $("#subNameInput").removeClass("incorrect-input");
    });
    $("#subNameInput").mousedown(function() {
        $("#subNameInput").removeClass("incorrect-input");
    });

    $("#cancelButton").click(function() {
        for (var xhr in downloadRequests) {
            xhr.abort();
        }
        doneDownloading();
    });

    function updateCancelButton() {
        $("#cancelButton").val("downloaded " + downloadedCount + " image" + (downloadedCount == 1 ? "" : "s") + ".. press to cancel");
    }

    function doneDownloading() {
        clearInterval(downloadInterval);

        if (downloadedCount > 0) {
            zip.generateAsync({ type:"blob" })
                .then(function(content) {
                    saveAs(content, "r-" + subName + "-images.zip");
                });
        }

        $("#downloadButton").show();
        $("#cancelButton").hide();
    }

    function downloadImageAsBase64(url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.onload = function() {
            downloadRequests.delete(this);

            var reader = new FileReader();
            reader.onloadend = function() {
                callback(url, reader.result.replace(/^data:.+\/(.+);base64,/, ""));
            }
            reader.readAsDataURL(xhr.response);
        };
        xhr.open('GET', CORS_PROXY_URL + url);
        xhr.responseType = 'blob';
        xhr.send();

        downloadRequests.add(xhr);
    }
</script>
</body>
</html>
